name: Build-wheels and publish to PyPI

# This workflow builds "wheels", which are the binary package installers hosted on PyPI.
# GitHub Actions is super helpful here because each one needs to be compiled in its own
# target environment. The wheel files are saved as artifacts, which you can download from
# the GitHub website. Wheels should be uploaded manually to PyPI -- see CONTRIBUTING.md.

# The Linux wheels cannot be generated using `ubuntu-latest` because they require a
# special Docker image to provide cross-Linux compatibility. There are at least a couple
# of third-party actions set up using the official image; we could switch to another if
# this ever breaks.

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - "v*" # Push events to matching v*, i.e. v1.0, v20.15.10  pull_request:
  release:
  workflow_dispatch:

jobs:

  build-manylinux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
#      with:
#        ref: 'v0.6'  # enable to check out prior version of codebase
    - name: Build wheels
      uses: RalfG/python-wheels-manylinux-build@v0.5.0
      with:
        python-versions: 'cp311-cp311 cp312-cp312 cp313-cp313 cp314-cp314'
    - name: Save artifacts
      uses: actions/upload-artifact@v2
      with:
        name: wheels
        path: dist/*-manylinux*.whl
    - name: Publish distribution ðŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_PASSWORD }}

  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash -l {0}  # needed for conda persistence
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
    - uses: actions/checkout@v2
#      with:
#        ref: 'v0.6'  # enable to check out prior version of codebase
    - name: Set up Python ${{ matrix.python-version }}
      uses: conda-incubator/setup-miniconda@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Set up environment
      run: |
        conda config --append channels conda-forge
        conda install build cxx-compiler clang llvm-openmp
    - name: Build wheel
      run: |
        python -m build --sdist --wheel
    - name: Save artifacts
      uses: actions/upload-artifact@v2
      with:
        name: wheels
        path: dist/*.whl

    - name: Create Release Notes
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          await github.request(`POST /repos/${{ github.repository }}/releases`, {
            tag_name: "${{ github.ref }}",
            generate_release_notes: true
          });
    
    - name: Publish distribution ðŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_PASSWORD }}